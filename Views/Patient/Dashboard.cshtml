@{
    ViewData["Title"] = "Patient Dashboard";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <h2>Welcome, <span id="patientName">Loading...</span></h2>
            <hr>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Profile Information</h5>
                    <div id="profileInfo">
                        <p>
                            <strong>Email:</strong> <span id="email"></span>
                        </p>
                        <p>
                            <strong>Phone:</strong> <span id="phone"></span>
                        </p>
                        <p>
                            <strong>Gender:</strong> <span id="gender"></span>
                        </p>
                        <p>
                            <strong>DOB:</strong> <span id="dob"></span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">My Appointments</h5>
                    <div id="appointmentsList">
                        <p class="text-center">Loading appointments...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/auth-service.js"></script>
    <script>
        // Check authentication
        if (!authService.isAuthenticated()) {
            window.location.href = '/Account/Login';
        }

        const userInfo = authService.getUserInfo();
        
        // Check role
        if (userInfo.role !== 'Patient') {
            alert('Access denied');
            authService.logout();
        }

        document.getElementById('patientName').textContent = userInfo.username;

        // Load profile data
        async function loadProfile() {
            try {
                const profile = await authService.apiCall('/api/patient/profile');
                document.getElementById('email').textContent = profile.email;
                document.getElementById('phone').textContent = profile.phone;
                document.getElementById('gender').textContent = profile.gender;
                document.getElementById('dob').textContent = new Date(profile.dob).toLocaleDateString();
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        // Load appointments
        async function loadAppointments() {
            try {
                const appointments = await authService.apiCall('/api/patient/appointments');
                const appointmentsList = document.getElementById('appointmentsList');
                
                if (appointments.length === 0) {
                    appointmentsList.innerHTML = '<p class="text-center">No appointments found</p>';
                    return;
                }

                let html = '<div class="list-group">';
                appointments.forEach(apt => {
                    html += `
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">${new Date(apt.appointmentDateTime).toLocaleString()}</h6>
                                <small class="badge bg-${apt.status === 'Confirmed' ? 'success' : 'warning'}">${apt.status}</small>
                            </div>
                            <p class="mb-1"><strong>Doctor:</strong> ${apt.doctor}</p>
                            <small>${apt.notes || 'No notes'}</small>
                        </div>
                    `;
                });
                html += '</div>';
                
                appointmentsList.innerHTML = html;
            } catch (error) {
                console.error('Error loading appointments:', error);
                document.getElementById('appointmentsList').innerHTML = 
                    '<p class="text-danger text-center">Error loading appointments</p>';
            }
        }

        // Load data on page load
        loadProfile();
        loadAppointments();
    </script>
}